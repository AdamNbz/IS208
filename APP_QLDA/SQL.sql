ALTER SESSION SET CURRENT_SCHEMA = QLDA;

-- BẢNG VAI TRÒ NGƯỜI DÙNG
CREATE TABLE VAITRO (
    MAVT VARCHAR2(10) PRIMARY KEY,
    TENVT VARCHAR2(50) NOT NULL
);
-- BẢNG NGƯỜI DÙNG
CREATE TABLE NGUOIDUNG (
    MAND VARCHAR2(10) PRIMARY KEY,
    TENND VARCHAR2(100) NOT NULL,
    TENDANGNHAP VARCHAR2(50) UNIQUE NOT NULL,
    MATKHAU VARCHAR2(100) NOT NULL,
    MAVT VARCHAR2(10),
    TRANGTHAI NUMBER(1) DEFAULT 1, -- 1: hoạt động, 0: khóa
    FOREIGN KEY (MAVT) REFERENCES VAITRO(MAVT)
);

-- BẢNG SẢN PHẨM
CREATE TABLE SANPHAM (
    MASP VARCHAR2(10) PRIMARY KEY,
    TENSP VARCHAR2(100) NOT NULL,
    MALOAI VARCHAR2(10) NOT NULL,
    TONKHO NUMBER DEFAULT 0,
    MANCC VARCHAR2(10) NOT NULL,
    FOREIGN KEY (MALOAI) REFERENCES LOAISP (MALOAI),
    FOREIGN KEY (MANCC) REFERENCES NHACUNGCAP (MANCC)
);

CREATE TABLE PHIEUNHAPXUAT (
    MAPHIEU VARCHAR2(10) PRIMARY KEY,
    LOAI    VARCHAR2(10) CHECK (LOAI IN ('NHAP', 'XUAT')), -- loại phiếu
    NGAYLAP DATE DEFAULT SYSDATE,
    MAND    VARCHAR2(10) NOT NULL,
    GHICHU  VARCHAR2(200),
    TRANGTHAI VARCHAR2(20),
    FOREIGN KEY (MAND) REFERENCES NGUOIDUNG(MAND)
);

CREATE TABLE CHITIETNHAPXUAT (
    MACT VARCHAR2(10) PRIMARY KEY,
    MAPHIEU VARCHAR2(10) NOT NULL,
    MASP VARCHAR2(10) NOT NULL,
    SOLUONG NUMBER NOT NULL CHECK (SOLUONG > 0),
    FOREIGN KEY (MAPHIEU) REFERENCES PHIEUNHAPXUAT(MAPHIEU) ON DELETE CASCADE,
    FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)
);
CREATE TABLE NHACUNGCAP (
    MANCC   VARCHAR2(10) PRIMARY KEY,
    TENNCC  VARCHAR2(100) NOT NULL,
    SDT     VARCHAR2(15),
    DIACHI  VARCHAR2(200),
    EMAIL   VARCHAR2(100)
);
CREATE TABLE LOAISP (
    MALOAI  VARCHAR2(10) PRIMARY KEY,
    TENLOAI VARCHAR2(100) NOT NULL,
    DONVITINH VARCHAR2(20)
);
CREATE TABLE THONGKE (
    MATK            VARCHAR2(10) PRIMARY KEY,
    NOIDUNG         VARCHAR2(100),
    NGAY            DATE,
    TONGPHIEUXUAT   NUMBER,
    TONGPHIEUNHAP   NUMBER,
    TONGSPNHAP      NUMBER,
    TONGSPXUAT      NUMBER
);
CREATE TABLE THONGKESP (
    MATKSP   VARCHAR2(10) PRIMARY KEY,
    MATK     VARCHAR2(10),
    MASP     VARCHAR2(10),
    TONKHO   NUMBER,
    CONSTRAINT FK_TKSP_THONGKE FOREIGN KEY (MATK) REFERENCES THONGKE(MATK),
    CONSTRAINT FK_TKSP_SANPHAM FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)
);


INSERT INTO SANPHAM (
  MASP, TENSP, LOAISP, DONVITINH, TONKHO
)
VALUES ('SP001', 'Snack Khoai Tay', 'Bánh', 'Bịch', 100);
COMMIT;
INSERT INTO SANPHAM (MASP, TENSP, LOAISP, DONVITINH, TONKHO) VALUES
('SP03', 'Bộ dao nhà bếp', 'Đồ bếp', 'Bộ', 20);
INSERT INTO VAITRO (MAVT, TENVT) VALUES ('ADMIN', 'Quản trị hệ thống');

INSERT INTO VAITRO (MAVT, TENVT) VALUES ('NK', 'Nhân viên nhập kho');

INSERT INTO VAITRO (MAVT, TENVT) VALUES ('XK', 'Nhân viên xuất kho');

INSERT INTO VAITRO (MAVT, TENVT) VALUES ('QLK', 'Quản lý kho');
INSERT INTO NGUOIDUNG (MAND, TENND, TENDANGNHAP, MATKHAU, MAVT, TRANGTHAI)
VALUES ('NV01', 'Nguyễn Văn A', 'nguyenvana', 'matkhau1', 'NK', 1);

INSERT INTO NGUOIDUNG (MAND, TENND, TENDANGNHAP, MATKHAU, MAVT, TRANGTHAI)
VALUES ('NV02', 'Trần Thị B', 'tranthib', 'matkhau2', 'XK', 1);

INSERT INTO NGUOIDUNG (MAND, TENND, TENDANGNHAP, MATKHAU, MAVT, TRANGTHAI)
VALUES ('NV03', 'Lê Văn C', 'levanc', 'matkhau3', 'QLK', 1);

INSERT INTO NGUOIDUNG (MAND, TENND, TENDANGNHAP, MATKHAU, MAVT, TRANGTHAI)
VALUES ('AD01', 'Admin Hệ Thống', 'admin', 'adminpass', 'ADMIN', 1);

-- Phiếu nhập

INSERT INTO PHIEUNHAPXUAT (MAPHIEU, LOAI, NGAYLAP, MAND, GHICHU, TRANGTHAI) 
VALUES ('PN001', 'NHAP', TO_DATE('2025-05-10','YYYY-MM-DD'), 'NV01', 'Nhập hàng từ NCC A', 'Chờ duyệt');

INSERT INTO PHIEUNHAPXUAT (MAPHIEU, LOAI, NGAYLAP, MAND, GHICHU, TRANGTHAI) 
VALUES ('PN002', 'NHAP', TO_DATE('2025-05-11','YYYY-MM-DD'), 'NV02', 'Nhập hàng từ NCC B', 'Chờ duyệt');

-- Phiếu xuất
INSERT INTO PHIEUNHAPXUAT (MAPHIEU, LOAI, NGAYLAP, MAND, GHICHU, TRANGTHAI) 
VALUES ('PX001', 'XUAT', TO_DATE('2025-05-12','YYYY-MM-DD'), 'NV03', 'Xuất hàng cho khách A', 'Chờ duyệt');

INSERT INTO PHIEUNHAPXUAT (MAPHIEU, LOAI, NGAYLAP, MAND, GHICHU, TRANGTHAI) 
VALUES ('PX002', 'XUAT', TO_DATE('2025-05-13','YYYY-MM-DD'), 'NV01', 'Xuất hàng nội bộ', 'Chờ duyệt');

-- Chi tiết phiếu nhập PN001
INSERT INTO CHITIETNHAPXUAT (MACT, MAPHIEU, MASP, SOLUONG) 
VALUES ('CT001', 'PN001', 'SP01', 10);

INSERT INTO CHITIETNHAPXUAT (MACT, MAPHIEU, MASP, SOLUONG) 
VALUES ('CT002', 'PN001', 'SP02', 15);

-- Chi tiết phiếu nhập PN002
INSERT INTO CHITIETNHAPXUAT (MACT, MAPHIEU, MASP, SOLUONG) 
VALUES ('CT003', 'PN002', 'SP03', 5);

-- Chi tiết phiếu xuất PX001
INSERT INTO CHITIETNHAPXUAT (MACT, MAPHIEU, MASP, SOLUONG) 
VALUES ('CT004', 'PX001', 'SP01', 3);

INSERT INTO CHITIETNHAPXUAT (MACT, MAPHIEU, MASP, SOLUONG) 
VALUES ('CT005', 'PX001', 'SP02', 2);

-- Chi tiết phiếu xuất PX002
INSERT INTO CHITIETNHAPXUAT (MACT, MAPHIEU, MASP, SOLUONG) 
VALUES ('CT006', 'PX002', 'SP03', 1);

CREATE OR REPLACE TRIGGER TRG_AUTO_CHI_TIET_NHAP_XUAT_ID
BEFORE INSERT ON CHITIETNHAPXUAT
FOR EACH ROW
BEGIN
    :NEW.MACT := TO_CHAR(SYSDATE, 'MMDDHH24MISS');
END;
/

CREATE OR REPLACE TRIGGER TRG_AUTO_NGUOI_DUNG_ID
BEFORE INSERT ON NGUOIDUNG
FOR EACH ROW
BEGIN
    :NEW.MAND := TO_CHAR(SYSDATE, 'MMDDHH24MISS');
END;
/
SELECT DISTINCT(S.LOAISP) FROM SANPHAM s;
CREATE OR REPLACE TRIGGER TRG_AUTO_PHIEU_NHAP_HANG_ID
BEFORE INSERT ON PHIEUNHAPXUAT
FOR EACH ROW
BEGIN
    :NEW.MAPHIEU := TO_CHAR(SYSDATE, 'MMDDHH24MISS');
END;
/

CREATE OR REPLACE TRIGGER TRG_AUTO_SAN_PHAM_ID
BEFORE INSERT ON SANPHAM
FOR EACH ROW
BEGIN
    :NEW.MASP := TO_CHAR(SYSDATE, 'MMDDHH24MISS');
END;
/
CREATE OR REPLACE TRIGGER TRG_AUTO_KHACH_HANG_ID
BEFORE INSERT ON KHACHHANG
FOR EACH ROW
BEGIN
    :NEW.MAKH := TO_CHAR(SYSDATE, 'MMDDHH24MISS');
END;
/
CREATE OR REPLACE TRIGGER TRG_AUTO_LOAISP_ID
BEFORE INSERT ON LOAISP
FOR EACH ROW
BEGIN
    :NEW.MALOAI := TO_CHAR(SYSDATE, 'MMDDHH24MISS');
END;
/
CREATE OR REPLACE TRIGGER TRG_AUTO_NHA_CUNG_CAP_ID
BEFORE INSERT ON NHACUNGCAP
FOR EACH ROW
BEGIN
    :NEW.MANCC := TO_CHAR(SYSDATE, 'MMDDHH24MISS');
END;
/
COMMIT;

CREATE OR REPLACE PROCEDURE INSERT_THONGKE_TODAY (
    p_noidung IN VARCHAR2
) AS
    v_matk VARCHAR2(20);
    v_tongPhieuNhap   NUMBER;
    v_tongPhieuXuat   NUMBER;
    v_tongSPNhap      NUMBER;
    v_tongSPXuat      NUMBER;
BEGIN
    -- Sinh mã thống kê dựa trên timestamp
    v_matk := TO_CHAR(SYSDATE, 'MMDDHH24MISS');

    -- Thống kê số phiếu nhập hôm nay
    SELECT COUNT(*) INTO v_tongPhieuNhap
    FROM PHIEUNHAPXUAT
    WHERE LOAI = 'NHAP' AND TRUNC(NGAYLAP) = TRUNC(SYSDATE); 

    -- Thống kê số phiếu xuất hôm nay
    SELECT COUNT(*) INTO v_tongPhieuXuat
    FROM PHIEUNHAPXUAT
    WHERE LOAI = 'XUAT' AND TRUNC(NGAYLAP) = TRUNC(SYSDATE); 

    -- Tổng số sản phẩm nhập hôm nay
    SELECT NVL(SUM(CT.SOLUONG), 0)
    INTO v_tongSPNhap
    FROM PHIEUNHAPXUAT P
    JOIN CHITIETNHAPXUAT CT ON P.MAPHIEU = CT.MAPHIEU
    WHERE P.LOAI = 'NHAP' AND TRUNC(P.NGAYLAP) = TRUNC(SYSDATE); 

    -- Tổng số sản phẩm xuất hôm nay
    SELECT NVL(SUM(CT.SOLUONG), 0)
    INTO v_tongSPXuat
    FROM PHIEUNHAPXUAT P
    JOIN CHITIETNHAPXUAT CT ON P.MAPHIEU = CT.MAPHIEU
    WHERE P.LOAI = 'XUAT' AND TRUNC(P.NGAYLAP) = TRUNC(SYSDATE); 

    -- Ghi vào bảng THONGKE
    INSERT INTO THONGKE (
        MATK, NOIDUNG, NGAY,
        TONGPHIEUXUAT, TONGPHIEUNHAP,
        TONGSPNHAP, TONGSPXUAT
    ) VALUES (
        v_matk, p_noidung, SYSDATE,
        v_tongPhieuXuat, v_tongPhieuNhap,
        v_tongSPNhap, v_tongSPXuat
    );

    -- Ghi chi tiết tồn kho của từng sản phẩm vào THONGKESP
    FOR rec IN (
        SELECT MASP, TONKHO FROM SANPHAM
    ) LOOP
        INSERT INTO THONGKESP (
            MATKSP, MATK, MASP, TONKHO
        ) VALUES (
            TO_CHAR(SYSDATE, 'DDHH24MISS') || TO_CHAR(TRUNC(DBMS_RANDOM.VALUE(0, 10))),
            v_matk,
            rec.MASP,
            rec.TONKHO
        );
    END LOOP;

    COMMIT;
END;
/